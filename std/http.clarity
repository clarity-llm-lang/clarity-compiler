// std/http — Generic HTTP client for Clarity
//
// Provides ergonomic wrappers around the http_request / http_request_full
// built-in primitives for building REST API clients and runtime agent CLIs.
// All functions require the Network effect.
//
// Quick start:
//   import { get, post, post_json, request } from "std/http"
//
// For full response (status + body), use the *_full variants:
//   import { get_full, request_full } from "std/http"

module Http

// ---------------------------------------------------------------------------
// Simple convenience wrappers
// ---------------------------------------------------------------------------

// Perform a GET request. Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function get(url: String) -> Result<String, String> {
  http_request("GET", url, "{}", "")
}

// Perform a POST request with a plain-text body.
// Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function post(url: String, body: String) -> Result<String, String> {
  http_request("POST", url, "{\"Content-Type\":\"text/plain\"}", body)
}

// Perform a POST request with a JSON body.
// Sets Content-Type: application/json automatically.
// Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function post_json(url: String, json_body: String) -> Result<String, String> {
  http_request("POST", url, "{\"Content-Type\":\"application/json\"}", json_body)
}

// Perform a PUT request with a JSON body.
// Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function put_json(url: String, json_body: String) -> Result<String, String> {
  http_request("PUT", url, "{\"Content-Type\":\"application/json\"}", json_body)
}

// Perform a PATCH request with a JSON body.
// Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function patch_json(url: String, json_body: String) -> Result<String, String> {
  http_request("PATCH", url, "{\"Content-Type\":\"application/json\"}", json_body)
}

// Perform a DELETE request.
// Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function delete(url: String) -> Result<String, String> {
  http_request("DELETE", url, "{}", "")
}

// Perform an arbitrary HTTP request.
// `method`       — HTTP verb: "GET", "POST", "PUT", "PATCH", "DELETE", etc.
// `url`          — Full URL including scheme and path.
// `headers_json` — JSON object of header name→value pairs, e.g. {"Authorization":"Bearer tok"}.
//                  Use "{}" for no additional headers.
// `body`         — Request body string. Use "" for requests with no body.
// Returns Ok(response_body) on 2xx, Err("HTTP <status>: <body>") on non-2xx.
export effect[Network] function request(method: String, url: String, headers_json: String, body: String) -> Result<String, String> {
  http_request(method, url, headers_json, body)
}

// ---------------------------------------------------------------------------
// Full-response variants (returns status code alongside body)
// ---------------------------------------------------------------------------
// These always return Ok({\"status\":N,\"body\":\"...\"}) for any HTTP response.
// Only return Err on network-level failures (DNS, timeout, connection refused).
// Use json_get to extract "status" and "body" fields.

// GET with full response JSON.
export effect[Network] function get_full(url: String) -> Result<String, String> {
  http_request_full("GET", url, "{}", "")
}

// POST (JSON body) with full response JSON.
export effect[Network] function post_json_full(url: String, json_body: String) -> Result<String, String> {
  http_request_full("POST", url, "{\"Content-Type\":\"application/json\"}", json_body)
}

// Arbitrary request with full response JSON.
export effect[Network] function request_full(method: String, url: String, headers_json: String, body: String) -> Result<String, String> {
  http_request_full(method, url, headers_json, body)
}

// ---------------------------------------------------------------------------
// Bearer-token helpers (common for runtime agent APIs)
// ---------------------------------------------------------------------------

// GET with a Bearer token in the Authorization header.
export effect[Network] function get_auth(url: String, token: String) -> Result<String, String> {
  let headers = "{\"Authorization\":\"Bearer " ++ token ++ "\"}";
  http_request("GET", url, headers, "")
}

// POST JSON with a Bearer token in the Authorization header.
export effect[Network] function post_json_auth(url: String, token: String, json_body: String) -> Result<String, String> {
  let headers = "{\"Content-Type\":\"application/json\",\"Authorization\":\"Bearer " ++ token ++ "\"}";
  http_request("POST", url, headers, json_body)
}

// Full-response GET with a Bearer token.
export effect[Network] function get_auth_full(url: String, token: String) -> Result<String, String> {
  let headers = "{\"Authorization\":\"Bearer " ++ token ++ "\"}";
  http_request_full("GET", url, headers, "")
}

// Full-response POST JSON with a Bearer token.
export effect[Network] function post_json_auth_full(url: String, token: String, json_body: String) -> Result<String, String> {
  let headers = "{\"Content-Type\":\"application/json\",\"Authorization\":\"Bearer " ++ token ++ "\"}";
  http_request_full("POST", url, headers, json_body)
}
