// std/http â€” Generic HTTP client for Clarity
//
// Ergonomic wrappers around http_request / http_request_full for building
// REST clients, runtime bridges, and CLI tools.
//
// All functions require the Network effect.

module Http

// ---------------------------------------------------------------------------
// Basic request helpers
// ---------------------------------------------------------------------------

// Perform a GET request. Returns Ok(body) on 2xx, Err(message) otherwise.
export effect[Network] function get(url: String) -> Result<String, String> {
  http_request("GET", url, "{}", "")
}

// Perform a GET request with Bearer auth.
export effect[Network] function get_with_auth(url: String, token: String) -> Result<String, String> {
  let headers = "{\"Authorization\":\"Bearer " ++ json_escape_string(token) ++ "\"}";
  http_request("GET", url, headers, "")
}

// Alias used by newer stdlib-style callers.
export effect[Network] function get_auth(url: String, token: String) -> Result<String, String> {
  get_with_auth(url, token)
}

// Perform a plain-text POST request.
export effect[Network] function post(url: String, body: String) -> Result<String, String> {
  http_request("POST", url, "{\"Content-Type\":\"text/plain\"}", body)
}

// Perform a JSON POST request.
export effect[Network] function post_json(url: String, body: String) -> Result<String, String> {
  http_request("POST", url, "{\"Content-Type\":\"application/json\"}", body)
}

// Perform a JSON POST request with Bearer auth.
export effect[Network] function post_json_with_auth(url: String, token: String, body: String) -> Result<String, String> {
  let headers = "{\"Content-Type\":\"application/json\",\"Authorization\":\"Bearer " ++ json_escape_string(token) ++ "\"}";
  http_request("POST", url, headers, body)
}

// Alias used by newer stdlib-style callers.
export effect[Network] function post_json_auth(url: String, token: String, body: String) -> Result<String, String> {
  post_json_with_auth(url, token, body)
}

// Perform PUT/PATCH/DELETE convenience requests.
export effect[Network] function put_json(url: String, body: String) -> Result<String, String> {
  http_request("PUT", url, "{\"Content-Type\":\"application/json\"}", body)
}

export effect[Network] function patch_json(url: String, body: String) -> Result<String, String> {
  http_request("PATCH", url, "{\"Content-Type\":\"application/json\"}", body)
}

export effect[Network] function delete(url: String) -> Result<String, String> {
  http_request("DELETE", url, "{}", "")
}

// Perform an arbitrary HTTP request.
export effect[Network] function request(method: String, url: String, headers_json: String, body: String) -> Result<String, String> {
  http_request(method, url, headers_json, body)
}

// ---------------------------------------------------------------------------
// Full-response helpers (status + body payload)
// ---------------------------------------------------------------------------

// GET with full response payload:
// Ok("{\"status\":200,\"body\":\"...\"}") or Err(network_error)
export effect[Network] function get_full(url: String) -> Result<String, String> {
  http_request_full("GET", url, "{}", "")
}

// GET with Bearer auth and full response payload.
export effect[Network] function get_auth_full(url: String, token: String) -> Result<String, String> {
  let headers = "{\"Authorization\":\"Bearer " ++ json_escape_string(token) ++ "\"}";
  http_request_full("GET", url, headers, "")
}

// POST JSON with full response payload.
export effect[Network] function post_json_full(url: String, body: String) -> Result<String, String> {
  http_request_full("POST", url, "{\"Content-Type\":\"application/json\"}", body)
}

// POST JSON + Bearer auth with full response payload.
export effect[Network] function post_json_auth_full(url: String, token: String, body: String) -> Result<String, String> {
  let headers = "{\"Content-Type\":\"application/json\",\"Authorization\":\"Bearer " ++ json_escape_string(token) ++ "\"}";
  http_request_full("POST", url, headers, body)
}

// Arbitrary request returning full response payload.
export effect[Network] function request_full(method: String, url: String, headers_json: String, body: String) -> Result<String, String> {
  http_request_full(method, url, headers_json, body)
}

// ---------------------------------------------------------------------------
// JSON extraction helper
// ---------------------------------------------------------------------------

// GET a URL and extract one top-level JSON field from the response body.
export effect[Network] function get_json_field(url: String, field: String) -> Result<String, String> {
  match get(url) {
    Err(msg) -> Err(msg),
    Ok(body) -> match json_get(body, field) {
      Some(v) -> Ok(v),
      None -> Err("field not found: " ++ field)
    }
  }
}
